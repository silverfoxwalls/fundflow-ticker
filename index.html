<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fund Flow Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>üìä Fund Flow Dashboard</h1>
  <div id="error-box" class="error" style="display:none"></div>
  <p>Last updated: <span id="last-updated">‚Äî</span></p>

  <table>
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Price</th>
        <th>% Change</th>
        <th>Quote Volume</th>
        <th>Fund Flow</th>
        <th>Liquidation</th>
      </tr>
    </thead>
    <tbody id="ticker-body">
      <tr><td colspan="6" class="loading">Loading‚Ä¶</td></tr>
    </tbody>
  </table>

  <style>
    body { font-family: system-ui, sans-serif; padding: 2rem; background: #101624; color: #eef1ff; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #2a3350; }
    .loading { text-align: center; color: #7781a8; }
    .error { padding: 0.75rem; background: #ff4d62; color: #1a0b0f; margin-bottom: 1rem; border-radius: 6px; }
    .pos { color: #3ae374; }
    .neg { color: #ff6b6b; }
    .liq-note { color: #8892b0; font-size: 0.85rem; margin-top: 0.25rem; }
  </style>

  <script>
    (function () {
      var API_URL = "/api/ticker";
      var tableBody = document.getElementById("ticker-body");
      var updatedAt = document.getElementById("last-updated");
      var errorBox = document.getElementById("error-box");

      if (!tableBody || !updatedAt) {
        console.error("Required DOM nodes not found.");
        return;
      }

      console.log("Dashboard script loaded ‚Äì requesting data‚Ä¶");
      loadData();
      setInterval(loadData, 15000);

      function loadData() {
        toggleError(false);
        tableBody.innerHTML = '<tr><td colspan="6" class="loading">Loading‚Ä¶</td></tr>';

        fetchTicker()
          .then(function (payload) {
            console.log("Ticker payload received", payload);
            renderRows(payload);
            if (payload && typeof payload.ts === "number") {
              updatedAt.textContent = new Date(payload.ts).toLocaleTimeString();
            } else {
              updatedAt.textContent = "‚Äî";
            }
          })
          .catch(function (err) {
            renderError(err);
          });
      }

      function fetchTicker() {
        return fetch(API_URL, { method: "GET" })
          .then(function (res) {
            if (!res.ok) {
              return res.text().then(function (text) {
                throw new Error("API " + res.status + ": " + text);
              });
            }
            return res.json();
          });
      }

      function renderRows(payload) {
        if (!payload || !payload.data || !payload.data.length) {
          tableBody.innerHTML = '<tr><td colspan="6" class="loading">No data returned.</td></tr>';
          return;
        }

        var rows = payload.data.map(function (item) {
          return (
            "<tr>" +
              "<td>" + escapeHTML(item.symbol) + "</td>" +
              "<td>" + formatNumber(item.price) + "</td>" +
              '<td class="' + (item.change >= 0 ? "pos" : "neg") + '">' +
                formatNumber(item.change, 2) + "%</td>" +
              "<td>" + formatNumber(item.quoteVolume, 0) + "</td>" +
              "<td>" + formatNumber(item.fundFlow, 0) + "</td>" +
              "<td>" + renderLiqLevels(item.liquidation) + "</td>" +
            "</tr>"
          );
        });

        tableBody.innerHTML = rows.join("");
      }

      function renderError(err) {
        console.error("Dashboard error:", err);
        toggleError(true, err && err.message ? err.message : "Unknown error");
        tableBody.innerHTML = '<tr><td colspan="6" class="loading">‚Äî</td></tr>';
        updatedAt.textContent = "‚Äî";
      }

      function toggleError(show, message) {
        if (!errorBox) return;
        errorBox.style.display = show ? "block" : "none";
        errorBox.textContent = show ? "‚ö†Ô∏è " + message : "";
      }

      function renderLiqLevels(liquidation) {
        if (!liquidation || !liquidation.hasPosition) {
          var note = liquidation && liquidation.message ? liquidation.message : "No active futures position";
          return '<div>‚Äî</div><div class="liq-note">' + escapeHTML(note) + "</div>";
        }

        return (
          "<div>" + escapeHTML(liquidation.marginType) + " | " + escapeHTML(String(liquidation.leverage)) + "√ó</div>" +
          "<div>Entry: " + formatNumber(liquidation.entryPrice, 2) + "</div>" +
          "<div>Mark: " + formatNumber(liquidation.markPrice, 2) + "</div>" +
          "<div>Liquidation: " + formatNumber(liquidation.liquidationPrice, 2) + "</div>" +
          "<div>PnL: " + formatNumber(liquidation.unrealizedProfit, 2) + "</div>"
        );
      }

      function formatNumber(value, decimals) {
        if (decimals === undefined) decimals = 2;
        var n = Number(value);
        if (!isFinite(n)) return "‚Äî";
        return n.toLocaleString("en-US", {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        });
      }

      function escapeHTML(value) {
        if (value === undefined || value === null) return "";
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }
    })();
  </script>
</body>
</html>
